# 备注

这个文档可不是DEBUG文档，而是备注文档。本文档主要用于极其粗略地说明独立按键的工作原理。

![image-20240630152458815](https://md-wind.oss-cn-nanjing.aliyuncs.com/md/%E7%8B%AC%E7%AB%8B%E6%8C%89%E9%94%AE.png)

上面是独立按键的构造图。

![image-20240630152700255](https://md-wind.oss-cn-nanjing.aliyuncs.com/md/%E7%8B%AC%E7%AB%8B%E6%8C%89%E9%94%AE%E5%8E%9F%E7%90%86%E5%9B%BE.png)

上面是独立按键的原理图，独立按键就连接在管脚上。最左边的是口线寄存器，在此种情况下，只需要知道它输出高电平；非门将高电平反向成低电平，与场效应管的栅极相连接；而场效应管的源极又接地，所以场效应管不导通。在按键不被按下的情况下，场效应管的漏极既不与栅极源极导通（场效应管是关闭的），又不与独立按键的GND连接（没按下），至于那个“输入数据”，只是发挥一个读取电位的功能，这就意味着漏极是一个悬空的状态，而漏极又通过上拉电阻与VCC相连，漏极又是悬空的，所以没有电流流过，没电位流过，那从VCC到漏极其电势都是相等的，这样“输入数据”就检测到了一个高电平；当按钮按下后，VCC就相当于中间隔着一个上拉电阻与GND相连，这样就形成回路了，由于这个上拉电阻的阻值很大，就会分担绝大多数的电压，漏极就会检测到低电平。



这里还有一个按键消抖需要讲。当按下或释放按键时，按键的接触点会在短时间内多次接触和分离，导致电平在高低之间快速切换。这种抖动时间通常在几毫秒到几十毫秒之间。由于电平信号并不稳定，所以电路系统就会误判按键状态。为了解决这个问题，可以从硬件和软件两个方向下功夫。

- 硬件

  1. 在按键与GND之间连接一个电容，并在按键与电位检测点之间连接一个电阻，从而实现RC低波滤通电路，具体原理我也不知道
  2. 使用施密特触发器，这个我更不知道。

- 软件

  1. 既然按键状态改变时的电平信号不稳定，那我就干脆不检测。一旦我检测到电平信号发生改变，那就先等一会，即延迟一会，再检测，如果过一会检测到的电平信号和刚开始的电平信号一致，那就承认此次的按键状态改变有效。那到底多长时间才算“一会”呢？这取决于两个方面：

  - 按键抖动的持续时间，一遍情况下，是几毫秒到几十毫秒
  - 系统的响应时间，通俗的说，类似于鼠标点击到电脑有反应的那段时间
    - 通常，延迟时间设置在10毫秒到50毫秒之间是比较常见的选择。具体的延迟时间可以根据实际情况进行调整。

  2. 连续多次读取按键状态，如果在一段时间内按键状态一致，则认为按键状态有效。

对于我们来说，当然用的是软件消抖，毕竟单片机上没有消抖硬件呀。





我觉得下面的原理讲的更好：

![image-20240711174030529](https://md-wind.oss-cn-nanjing.aliyuncs.com/md/202407111740632.png)

常用的按键电路有两种形式:独立式按键和矩阵式按键。独立式按键比较简单,它们各自与独立的输人线相连接,如图所示。

4条输人线接到单片机的I/〇口上,当按下按键`K1`时,`+5V` 依次通过电阻 `R1`	 和按键`K1	`最终进人 `GND`形成一条通路,这条线路的全部电压都加到电阻`R1`上,引脚 `KeyIn1` 就是一个低电平。当松开按键后,线路断开,不会有电流通过,`KeyIn1	`和`+5V`应该是等电位,是一个高电平。因此,可以通过引脚`KeyIn1`这个I/O口的高低电平来判断是否有按键按下。

首先说明一点,就是现在绝大多数单片机的l/0口都是使用MOS管而非三极管,但在这里的 MOS管,其原理和三极管是一样的,因此用三极管替代它来进行原理讲解,把前面讲过的三极管的知识搬过来,一切都是适用的,有助于理解。

方框内的电路都是指单片机内部部分,方框外的就是外接的上拉电阻和按键，这个地方大家要注意一下,就是当要读取外部按键信号的时候,单片机必须先给该引脚写“1”,也就是高电平,这样才能正确读取到外部按键信号,下面来分析一下缘由。

当内部输出是高电平时,经过一个反向器变成低电平,`NPN`三极管不会导通,单片机I/O口从内部来看,由于上拉电阻R的存在,所以是一个高电平。当外部没有按键按下将电平拉低,`VCC`也是`+5V	`,它们之间虽然有两个电阻,但是没有压差,就不会有电流,线上所有的位置都是高电平,这时就可以正常读取按键的状态了。

当内部输出是低电平时,经过一个反相器变成高电平,`NPN`三极管导通,单片机的内部I/〇口就是一个低电平,这时,外部虽然也有上拉电阻的存在,但是两个电阻是并联关系,不管按键是否按下,单片机的I/〇口上输人单片机内部的状态都是低电平,因此无法正常读取按键的状态。

这与水流很类似,内部和外部,只要有一边是低电位,电流就会顺流而下,由于只有上拉电阻,下边没有分压电阻,直接到`	GND`上,所以不管另一边是高电位还是低电位,电平都是低电平。
从上面的分析可以得出一个结论,这种具有上拉的准双向l/0口,如果要正常读取外部信号的状态,必须首先保证自己内部输出的是1,如果内部输出0,则无论外部信号是1还是0,这个引脚读进来的都是0。

















